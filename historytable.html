<!DOCTYPE html>
<html>
<body>
    <style>
        #j-hist-grid {
            position: absolute;
            background-color:#eee;
            overflow:auto;
            width: 100%;
            height:100%;
        }
        .extruder.right div.flap {
            left: -29px;
        }
        span.flapLabel {
            left: -7px;
        }
    </style>
    <link rel="stylesheet" type="text/css" href="css/JobTable.css">

    <script type="text/javascript">
        // fix position of flap
        $("div.flap").addClass("flapEx");
        
        // add gear icon (activity indicator)
        $("div.flap").prepend("<img class='cogwheel hidden' src='img/loading-gear-3.gif' />");

        //adjust grid height
        setInterval(function() {
            var h = $("div.extruder-content").height();
            //$("#j-hist-grid").height(h);
        },1000);
        
        setTimeout(function(){
            getJobs(function(data){
                jdata = $.parseJSON(data);
                
                console.dir(jdata);

                jdata.sort(function(a,b) {
                    if (a.id > b.id) return -1;
                    if (a.id < b.id) return 1;
                    else return 0;
                });
                
                for (var x in jdata) {
                    $("#j-hist-grid table").append("<tr id='"+jdata[x].id+"'><td class='state'>"+jdata[x].data.galaxy_data.state+"</td><td>"+jdata[x].data.galaxy_data.hid+"</td><td>"+jdata[x].data.galaxy_data.name+"</td></tr>")
                }
                
            });
        },3000);
        function getJobs(callback) {

            console.log("getjobs");
            $.ajax({
                url: "http://192.168.56.102:1337/api/jobs/0..10000",
                dataType: "text",
                success: function (data) {
                  callback(data);
                }
                // todo: handle errors
            });
        };
        
    </script>
    <script type="text/javascript">
        
        io.socket.on('test', function (event){
            console.log("message "+event.data.message);
            console.dir(event.data);
       
            if (event.data.message==="job-active") {
                console.log("event job-active "+event.data.count);
                if (0+event.data.count===0) $("img.cogwheel").addClass("hidden");
                else $("img.cogwheel").removeClass("hidden");
            }
            else if (event.data.message==="job-remove") {
                console.log("event job-remove "+event.data.job_id);
                $("#j-hist-grid tr#"+event.data.job_id).remove();
            }
            else if (event.data.message==="job-add") {
                console.log("event job-add "+event.data.job.id);
                var jdata = event.data.job;
                $('#j-hist-grid #head').after("<tr id='"+jdata.id+"'><td class='state'>"+jdata.data.galaxy_data.state+"</td><td>"+jdata.data.galaxy_data.hid+"</td><td>"+jdata.data.galaxy_data.name+"</td></tr>");                
            }
            else if (event.data.message==="job-change") {
                console.log("event job-change "+event.data.job.id);
                var jdata = event.data.job;
                var id = jdata.id;
                var newState = jdata.data.galaxy_data.state;
                $('#j-hist-grid #'+id+" .class").html(newState);
            }
            
        });            
        io.socket.get('/test', function gotResponse(body, response) {
          console.log('Current test: ', body);
        });            
</script>
    
    <div id="j-hist-grid">
        <div class="CSSTableGenerator" >
                <table >
                    <tr id="head">
                        <td>
                            State
                        </td>
                        <td >
                            ID
                        </td>
                        <td>
                            Operation
                        </td>
                    </tr>
                </table>
        </div>
            
    </div>
</body>
</html>

    